{"version":3,"sources":["../src/index.js"],"names":["Object","prototype","hasOwnProperty","call","process","env","console","log","$","set","dest","path","resolve","S3_TMP_UPLOAD_DIRETORY","storage","s3","aws","S3","bucket","S3_BUCKET_NAME","contentType","multerS3","AUTO_CONTENT_TYPE","acl","key","req","file","cb","crypto","randomBytes","err","hash","hashHex","toString","fileName","substring","originalname","extname","limits","fileSize","e","message"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;;;0EAIe;AAAA;AAAA;AAAA;AAAA;AACX,wBAAI;AACA,4BACI,CAACA,OAAOC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CACGC,QAAQC,GADX,EAEG,wBAFH,CADL,EAKE;AACE;AACAC,oCAAQC,GAAR,CACI,wEADJ;AAGH,yBAVD,MAUO,IACH,CAACP,OAAOC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCC,QAAQC,GAA7C,EAAkD,gBAAlD,CADE,EAEL;AACE;AACAC,oCAAQC,GAAR,CACI,gEADJ;AAGH,yBAPM,MAOA,IACH,CAACP,OAAOC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CACGC,QAAQC,GADX,EAEG,mBAFH,CADE,EAKL;AACE;AACAC,oCAAQC,GAAR,CACI,mEADJ;AAGH,yBAVM,MAUA,IACH,CAACP,OAAOC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CACGC,QAAQC,GADX,EAEG,uBAFH,CADE,EAKL;AACE;AACAC,oCAAQC,GAAR,CACI,uEADJ;AAGH,yBAVM,MAUA,IACH,CAACP,OAAOC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CACGC,QAAQC,GADX,EAEG,oBAFH,CADE,EAKL;AACE;AACAC,oCAAQC,GAAR,CACI,oEADJ;AAGH,yBAVM,MAUA;AACHC,qCAAEC,GAAF,CACI,IADJ,EAEI,sBAAO;AACHC,sCAAMC,eAAKC,OAAL,CAAaR,QAAQC,GAAR,CAAYQ,sBAAzB,CADH;AAEHC,yCAAS,uBAAS;AACdC,wCAAI,IAAIC,iBAAIC,EAAR,EADU;AAEdC,4CAAQd,QAAQC,GAAR,CAAYc,cAFN;AAGdC,iDAAaC,kBAASC,iBAHR;AAIdC,yCAAK,aAJS;AAKdC,yCAAK,aAACC,GAAD,EAAMC,IAAN,EAAYC,EAAZ,EAAmB;AACpBC,yDAAOC,WAAP,CAAmB,EAAnB,EAAuB,UAACC,GAAD,EAAMC,IAAN,EAAe;AAClC,gDAAID,GAAJ,EAASH,GAAGG,GAAH,EAAT,KACK;AACD,oDAAME,UAAUD,KAAKE,QAAL,CAAc,KAAd,CAAhB;AACA,oDAAMC,WAAcF,QAAQG,SAAR,CAChB,CADgB,EAEhB,CAFgB,CAAd,SAGDH,QAAQG,SAAR,CACD,CADC,EAED,CAFC,CAHC,SAMDH,QAAQG,SAAR,CACD,CADC,EAED,CAFC,CANC,SASDH,QAAQG,SAAR,CACD,CADC,EAED,EAFC,CATC,SAYDH,QAAQG,SAAR,CAAkB,EAAlB,EAAsB,EAAtB,CAZC,SAY4B,kBAC9BT,KAAKU,YADyB,CAZ5B,GAcFzB,eAAK0B,OAAL,CAAaX,KAAKU,YAAlB,CAdJ;AAeAT,mDAAG,IAAH,EAASO,QAAT;AACH;AACJ,yCArBD;AAsBH;AA5Ba,iCAAT,CAFN;AAgCHI,wCAAQ;AACJC,8CAAU,IAAI,IAAJ,GAAW;AADjB;AAhCL,6BAAP,CAFJ;AAuCH;AACJ,qBAzFD,CAyFE,OAAOC,CAAP,EAAU;AACR;AACAlC,gCAAQC,GAAR,eAAwBiC,EAAEC,OAA1B;AACH;;AA7FU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,C","file":"index.js","sourcesContent":["import multer from \"multer\";\r\nimport path from \"path\";\r\nimport crypto from \"crypto\";\r\nimport aws from \"aws-sdk\";\r\nimport multerS3 from \"multer-s3\";\r\nimport md5 from \"md5\";\r\n\r\nimport {\r\n    $\r\n} from \"@dekproject/scope\";\r\n\r\nexport default async () => {\r\n    try {\r\n        if (\r\n            !Object.prototype.hasOwnProperty.call(\r\n                process.env,\r\n                \"S3_TMP_UPLOAD_DIRETORY\"\r\n            )\r\n        ) {\r\n            // eslint-disable-next-line no-console\r\n            console.log(\r\n                \"[ S3 ] - There is no S3_TMP_UPLOAD_DIRETORY variable in the .env file.\"\r\n            );\r\n        } else if (\r\n            !Object.prototype.hasOwnProperty.call(process.env, \"S3_BUCKET_NAME\")\r\n        ) {\r\n            // eslint-disable-next-line no-console\r\n            console.log(\r\n                \"[ S3 ] - There is no S3_BUCKET_NAME variable in the .env file.\"\r\n            );\r\n        } else if (\r\n            !Object.prototype.hasOwnProperty.call(\r\n                process.env,\r\n                \"AWS_ACCESS_KEY_ID\"\r\n            )\r\n        ) {\r\n            // eslint-disable-next-line no-console\r\n            console.log(\r\n                \"[ S3 ] - There is no AWS_ACCESS_KEY_ID variable in the .env file.\"\r\n            );\r\n        } else if (\r\n            !Object.prototype.hasOwnProperty.call(\r\n                process.env,\r\n                \"AWS_SECRET_ACCESS_KEY\"\r\n            )\r\n        ) {\r\n            // eslint-disable-next-line no-console\r\n            console.log(\r\n                \"[ S3 ] - There is no AWS_SECRET_ACCESS_KEY variable in the .env file.\"\r\n            );\r\n        } else if (\r\n            !Object.prototype.hasOwnProperty.call(\r\n                process.env,\r\n                \"AWS_DEFAULT_REGION\"\r\n            )\r\n        ) {\r\n            // eslint-disable-next-line no-console\r\n            console.log(\r\n                \"[ S3 ] - There is no AWS_DEFAULT_REGION variable in the .env file.\"\r\n            );\r\n        } else {\r\n            $.set(\r\n                \"s3\",\r\n                multer({\r\n                    dest: path.resolve(process.env.S3_TMP_UPLOAD_DIRETORY),\r\n                    storage: multerS3({\r\n                        s3: new aws.S3(),\r\n                        bucket: process.env.S3_BUCKET_NAME,\r\n                        contentType: multerS3.AUTO_CONTENT_TYPE,\r\n                        acl: \"public-read\",\r\n                        key: (req, file, cb) => {\r\n                            crypto.randomBytes(16, (err, hash) => {\r\n                                if (err) cb(err);\r\n                                else {\r\n                                    const hashHex = hash.toString(\"hex\");\r\n                                    const fileName = `${hashHex.substring(\r\n                                        0,\r\n                                        2\r\n                                    )}/${hashHex.substring(\r\n                                        2,\r\n                                        5\r\n                                    )}/${hashHex.substring(\r\n                                        5,\r\n                                        9\r\n                                    )}/${hashHex.substring(\r\n                                        9,\r\n                                        14\r\n                                    )}/${hashHex.substring(14, 20)}/${md5(\r\n                                        file.originalname\r\n                                    )}${path.extname(file.originalname)}`;\r\n                                    cb(null, fileName);\r\n                                }\r\n                            });\r\n                        },\r\n                    }),\r\n                    limits: {\r\n                        fileSize: 5 * 1024 * 1024,\r\n                    },\r\n                })\r\n            );\r\n        }\r\n    } catch (e) {\r\n        // eslint-disable-next-line no-console\r\n        console.log(`[ S3 ] - ${e.message}`);\r\n    }\r\n};\r\n"]}